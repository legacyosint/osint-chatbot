<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSINT // ANALYZER</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark-reasonable.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        /* --- THEME VARIABLES --- */
        :root[data-theme="dark"] {
            --bg-app: #050505;
            --bg-sidebar: #0c0c0c;
            --bg-chat: #050505;
            --bg-input: #111111;
            --bg-hover: #1a1a1a;
            --bg-dropdown: #181818;
            --border-color: #222;
            --accent-color: #00ff9d; /* Cyber Green */
            --text-primary: #e0e0e0;
            --text-secondary: #888;
            --bot-msg-bg: #0c0c0c;
            --user-msg-bg: #111;
            --shadow: 0 4px 12px rgba(0,0,0,0.5);
        }

        :root[data-theme="light"] {
            /* A "Cyber-Light" theme - high contrast, stark */
            --bg-app: #f0f2f5;
            --bg-sidebar: #ffffff;
            --bg-chat: #f8f9fa;
            --bg-input: #ffffff;
            --bg-hover: #e4e6e9;
            --bg-dropdown: #ffffff;
            --border-color: #dce0e5;
            --accent-color: #0066ff; /* Cyber Blue */
            --text-primary: #1c1e21;
            --text-secondary: #606770;
            --bot-msg-bg: #ffffff;
            --user-msg-bg: #e4e6e9;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* --- GLOBAL STYLES --- */
        body {
            margin: 0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-app);
            color: var(--text-primary);
            display: flex;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Material Symbol Icons sizing */
        .material-symbols-outlined { font-size: 20px; }
        .icon-sm { font-size: 16px; }

        /* --- LAYOUT --- */
        .app-container { display: flex; width: 100%; height: 100%; }

        /* --- SIDEBAR --- */
        #sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            transition: width 0.3s ease;
            flex-shrink: 0;
        }

        #sidebar.collapsed { width: 60px; }
        #sidebar.collapsed .hide-on-collapse { display: none; }
        #sidebar.collapsed .sidebar-header { padding: 15px 0; justify-content: center; }

        .sidebar-header {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            height: 60px; box-sizing: border-box;
        }
        
        .brand-text { font-weight: 700; font-family: monospace; letter-spacing: 1px; white-space: nowrap;}

        .sidebar-btn-icon {
            cursor: pointer; color: var(--text-secondary); padding: 5px; border-radius: 50%; transition: 0.2s;
            background: transparent; border: none; display: flex; align-items: center; justify-content: center;
        }
        .sidebar-btn-icon:hover { background: var(--bg-hover); color: var(--text-primary); }

        .new-chat-btn-container { padding: 10px 15px; }
        .new-chat-btn {
            display: flex; align-items: center; gap: 10px;
            background: var(--bg-input); color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 10px 15px; border-radius: 8px; cursor: pointer; width: 100%; box-sizing: border-box;
            transition: 0.2s; white-space: nowrap;
        }
        .new-chat-btn:hover { background: var(--bg-hover); border-color: var(--accent-color); }

        /* Chat History List */
        .sidebar-nav-list { flex: 1; overflow-y: auto; padding: 10px 0; }
        .nav-section-title { 
            padding: 15px 20px 5px; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); 
        }
        
        .chat-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 15px 8px 20px; cursor: pointer; color: var(--text-primary);
            text-decoration: none; transition: 0.2s; position: relative;
            height: 40px;
        }
        .chat-item:hover { background: var(--bg-hover); }
        .chat-item.active { background: var(--bg-hover); }
        .chat-title-text { 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; font-size: 0.9rem; margin-left: 10px;
        }
        
        /* Sidebar Item Options Dropdown */
        .item-options-btn { opacity: 0; color: var(--text-secondary); transition: 0.2s; }
        .chat-item:hover .item-options-btn, .item-options-btn.active { opacity: 1; }
        .item-options-btn:hover { color: var(--text-primary); }

        /* Bottom Sidebar Menu */
        .sidebar-bottom-menu { margin-top: auto; border-top: 1px solid var(--border-color); padding: 10px 0;}
        .menu-item {
            display: flex; align-items: center; gap: 15px; padding: 10px 20px;
            cursor: pointer; color: var(--text-primary); transition: 0.2s; font-size: 0.9rem; text-decoration: none;
        }
        .menu-item:hover { background: var(--bg-hover); }
        
        /* --- MAIN CONTENT AREA --- */
        #main-content { flex: 1; display: flex; flex-direction: column; background: var(--bg-chat); position: relative; }

        /* Top Nav Bar */
        .top-nav {
            height: 60px; display: flex; align-items: center; padding: 0 20px;
            border-bottom: 1px solid var(--border-color); background: var(--bg-chat); box-sizing: border-box;
        }
        .current-chat-title-container {
            display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 5px 10px; border-radius: 6px;
            transition: 0.2s; position: relative;
        }
        .current-chat-title-container:hover { background: var(--bg-hover); }
        #current-chat-name { font-weight: 600; font-size: 1.1rem; }

        /* Dropdown Menus (General Style) */
        .dropdown-menu {
            position: absolute; top: 100%; left: 0;
            background: var(--bg-dropdown); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 5px; width: 200px; box-shadow: var(--shadow);
            display: none; z-index: 100;
        }
        .dropdown-menu.show { display: block; }
        .dropdown-item {
            display: flex; align-items: center; gap: 10px; padding: 10px;
            cursor: pointer; border-radius: 4px; transition: 0.2s; font-size: 0.9rem; color: var(--text-primary);
        }
        .dropdown-item:hover { background: var(--bg-hover); }
        .dropdown-item.danger { color: #ff4444; }
        .dropdown-item.danger:hover { background: rgba(255, 68, 68, 0.1); }

        /* Chat Area */
        #chat-scroll-area { flex: 1; overflow-y: auto; padding: 20px 0; scroll-behavior: smooth;}
        .message-container { max-width: 800px; margin: 0 auto; padding: 0 20px; }
        
        .message { margin-bottom: 25px; opacity: 0; animation: fadeIn 0.3s forwards; }
        @keyframes fadeIn { to { opacity: 1; } }

        .message-header { 
            display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; 
        }
        .bot-name { color: var(--accent-color); font-family: monospace; }
        
        /* Markdown Content Styling */
        .message-content { line-height: 1.6; font-size: 1rem; }
        .message-content pre {
            background: #1a1a1a; padding: 15px; border-radius: 6px; overflow-x: auto; border: 1px solid var(--border-color);
        }
        .message-content code { font-family: 'Consolas', monospace; }
        .message-content table { border-collapse: collapse; width: 100%; margin: 15px 0; }
        .message-content th, .message-content td { border: 1px solid var(--border-color); padding: 8px; text-align: left; }

        /* Welcome Screen */
        #welcome-screen {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; display: none; /* Hidden by default */
        }
        .welcome-text { font-size: 2.5rem; font-weight: 700; margin-bottom: 10px; opacity: 0; animation: slideUp 0.5s forwards; }
        .welcome-subtext { color: var(--text-secondary); margin-bottom: 30px; opacity: 0; animation: slideUp 0.5s 0.2s forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .bubble-container { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; opacity: 0; animation: fadeIn 0.5s 0.4s forwards;}
        .bubble-btn {
            background: var(--bg-input); border: 1px solid var(--border-color); padding: 10px 15px;
            border-radius: 20px; cursor: pointer; color: var(--text-primary); transition: 0.2s;
        }
        .bubble-btn:hover { border-color: var(--accent-color); background: var(--bg-hover); }

        /* Input Area */
        .input-footer {
            padding: 20px; background: var(--bg-chat); display: flex; justify-content: center;
        }
        .input-box-wrapper {
            width: 100%; max-width: 800px; background: var(--bg-input); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 10px; display: flex; align-items: flex-end; gap: 10px; position: relative;
            transition: border-color 0.2s;
        }
        .input-box-wrapper:focus-within { border-color: var(--accent-color); }

        .file-btn {
            cursor: pointer; color: var(--text-secondary); padding: 8px; border-radius: 50%;
        }
        .file-btn:hover { background: var(--bg-hover); color: var(--text-primary); }

        textarea {
            flex: 1; background: transparent; border: none; color: var(--text-primary);
            resize: none; max-height: 150px; min-height: 24px; font-family: inherit; font-size: 1rem; outline: none; padding-bottom: 8px;
        }
        .send-btn {
            background: var(--accent-color); color: #000; border: none; padding: 8px; border-radius: 8px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .send-btn:hover { opacity: 0.9; }
        .send-btn:disabled { background: var(--border-color); cursor: not-allowed; color: var(--text-secondary); }

        #file-preview-area {
            position: absolute; bottom: 100%; left: 0; background: var(--bg-input); padding: 10px;
            border-radius: 8px 8px 0 0; border: 1px solid var(--border-color); border-bottom: none;
            display: none; align-items: center; gap: 10px; color: var(--accent-color); font-size: 0.9rem;
        }

    </style>
</head>
<body>

<div class="app-container">
    <div id="sidebar">
        <div class="sidebar-header">
            <button class="sidebar-btn-icon" onclick="toggleSidebar()">
                <span class="material-symbols-outlined">menu</span>
            </button>
            <span class="brand-text hide-on-collapse">OSINT ANALYZER</span>
        </div>

        <div class="new-chat-btn-container hide-on-collapse">
            <button class="new-chat-btn" onclick="createNewSession()">
                <span class="material-symbols-outlined icon-sm">add</span>
                New chat
            </button>
        </div>

        <div class="sidebar-nav-list" id="history-list">
            <div class="nav-section-title hide-on-collapse">Chats</div>
            </div>

        <div class="sidebar-bottom-menu hide-on-collapse">
             <a href="https://docs.google.com/forms/d/e/1FAIpQLScxln0wQ_S7q69WEbE1WtjB4-cYaNphpRki0sLVqyBip2W5qA/viewform?usp=sharing" target="_blank" class="menu-item">
                <span class="material-symbols-outlined icon-sm">chat_bubble</span>
                Feedback
            </a>
            <div class="menu-item" onclick="toggleTheme()">
                <span class="material-symbols-outlined icon-sm" id="theme-icon">dark_mode</span>
                <span id="theme-text">Switch to Light Mode</span>
            </div>
            <div class="menu-item" onclick="showActivity()">
                <span class="material-symbols-outlined icon-sm">history</span>
                Activity
            </div>
        </div>
    </div>

    <div id="main-content">
        <div class="top-nav">
            <div class="current-chat-title-container" id="top-nav-title-trigger">
                <span id="current-chat-name">Select a chat</span>
                <span class="material-symbols-outlined icon-sm">expand_more</span>
                <div class="dropdown-menu" id="top-nav-dropdown">
                    <div class="dropdown-item"><span class="material-symbols-outlined icon-sm">share</span>Share conversation</div>
                    <div class="dropdown-item"><span class="material-symbols-outlined icon-sm">push_pin</span>Pin</div>
                    <div class="dropdown-item" onclick="renameCurrentSession()"><span class="material-symbols-outlined icon-sm">edit</span>Rename</div>
                    <div class="dropdown-item danger" onclick="deleteCurrentSession()"><span class="material-symbols-outlined icon-sm">delete</span>Delete</div>
                </div>
            </div>
        </div>

        <div id="chat-scroll-area">
            <div class="message-container" id="chat-container">
                </div>

            <div id="welcome-screen">
                <div class="welcome-text">Welcome Hacker,</div>
                <div class="welcome-subtext">create a chat and start your journey</div>
                <div class="bubble-container">
                    <button class="bubble-btn" onclick="startQuickAction('ü§ñ image')">ü§ñ image analysis</button>
                    <button class="bubble-btn" onclick="startQuickAction('üîé deep search')">üîé deep search</button>
                    <button class="bubble-btn" onclick="startQuickAction('How do I use common OSINT tools like Maltego?')">üõ†Ô∏è osint tools lists</button>
                </div>
            </div>
        </div>

        <div class="input-footer">
            <div class="input-box-wrapper">
                 <div id="file-preview-area">
                    <span class="material-symbols-outlined icon-sm">image</span>
                    <span id="file-name-text">image.png</span>
                    <span class="material-symbols-outlined icon-sm" style="cursor:pointer; color:var(--text-secondary)" onclick="clearFile()">close</span>
                </div>

                <label for="image-upload" class="file-btn">
                    <span class="material-symbols-outlined">attach_file</span>
                </label>
                <input type="file" id="image-upload" accept="image/*" style="display:none" onchange="handleFileSelect()">
                
                <textarea id="user-input" rows="1" placeholder="Enter OSINT query..." oninput="autoResize(this)" onkeydown="handleEnter(event)"></textarea>
                
                <button class="send-btn" id="send-button" onclick="sendMessage()" disabled>
                    <span class="material-symbols-outlined">arrow_upward</span>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="dropdown-menu" id="sidebar-context-menu">
    <div class="dropdown-item danger" id="sidebar-delete-btn"><span class="material-symbols-outlined icon-sm">delete</span>Delete</div>
</div>


<script>
    let currentSessionId = null;
    const API_URL = ''; // Keep empty for Render deployment
    let isSidebarCollapsed = false;
    let currentTheme = 'dark';

    // --- INITIALIZATION ---
    window.onload = async () => {
        // Initialize Theme
        const savedTheme = localStorage.getItem('theme') || 'dark';
        setTheme(savedTheme);

        // Load sessions, but don't auto-create one. Show welcome screen instead.
        await loadSessions();
        showWelcomeScreen(true); 
        checkInputState();

        // Global click listener to close dropdowns
        document.addEventListener('click', (e) => {
            closeAllDropdowns(e.target);
        });
    };

    // --- UI INTERACTIONS ---

    function toggleSidebar() {
        isSidebarCollapsed = !isSidebarCollapsed;
        document.getElementById('sidebar').classList.toggle('collapsed', isSidebarCollapsed);
    }

    function setTheme(theme) {
        currentTheme = theme;
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        const icon = document.getElementById('theme-icon');
        const text = document.getElementById('theme-text');
        if(theme === 'dark') {
            icon.innerText = 'light_mode';
            text.innerText = 'Switch to Light Mode';
        } else {
            icon.innerText = 'dark_mode';
            text.innerText = 'Switch to Dark Mode';
        }
    }
    
    function toggleTheme() {
        setTheme(currentTheme === 'dark' ? 'light' : 'dark');
    }

    function showWelcomeScreen(show) {
        document.getElementById('welcome-screen').style.display = show ? 'block' : 'none';
        document.getElementById('chat-container').style.display = show ? 'none' : 'block';
        if(show) {
             document.getElementById('current-chat-name').innerText = "Select a chat";
             currentSessionId = null;
             updateActiveSessionInSidebar();
        }
    }

    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
        checkInputState();
    }

    function checkInputState() {
        const text = document.getElementById('user-input').value.trim();
        const file = document.getElementById('image-upload').files.length > 0;
        document.getElementById('send-button').disabled = !(text || file);
    }

    function handleEnter(e) {
        if(e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    }

    function handleFileSelect() {
        const file = document.getElementById('image-upload').files[0];
        if(file) {
            document.getElementById('file-preview-area').style.display = 'flex';
            document.getElementById('file-name-text').innerText = file.name;
            checkInputState();
        }
    }
    
    function clearFile() {
        document.getElementById('image-upload').value = '';
        document.getElementById('file-preview-area').style.display = 'none';
        checkInputState();
    }

    // --- DROPDOWN MANAGEMENT ---
    
    // Top Nav Dropdown trigger
    document.getElementById('top-nav-title-trigger').addEventListener('click', function(e) {
        if(!currentSessionId) return; // Don't open if no chat selected
        e.stopPropagation();
        toggleDropdown('top-nav-dropdown');
    });

    function toggleDropdown(id) {
        const dropdown = document.getElementById(id);
        const isShowing = dropdown.classList.contains('show');
        closeAllDropdowns(); // Close others first
        if (!isShowing) dropdown.classList.add('show');
    }

    function closeAllDropdowns(targetClicked) {
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            // Don't close if we just clicked the trigger for this menu
            if (targetClicked && menu.parentElement.contains(targetClicked)) return;
            menu.classList.remove('show');
            menu.style.top = null; menu.style.left = null; menu.style.position = null; // Reset context menu styles
        });
         // Also remove active state from sidebar dots
         document.querySelectorAll('.item-options-btn').forEach(btn => btn.classList.remove('active'));
    }


    // --- CORE BACKEND / CHAT LOGIC ---

    async function loadSessions() {
        try {
            const res = await fetch(`${API_URL}/sessions`);
            const sessions = await res.json();
            const list = document.getElementById('history-list');
            // Keep title, clear items
            list.innerHTML = '<div class="nav-section-title hide-on-collapse">Chats</div>';
            
            sessions.forEach(s => {
                const item = document.createElement('div');
                item.className = `chat-item ${s.id === currentSessionId ? 'active' : ''}`;
                item.innerHTML = `
                    <span class="material-symbols-outlined icon-sm" style="color:var(--text-secondary)">chat_bubble_outline</span>
                    <span class="chat-title-text hide-on-collapse">${s.title}</span>
                    <span class="material-symbols-outlined icon-sm item-options-btn hide-on-collapse" onclick="openSidebarMenu(event, ${s.id})">more_horiz</span>
                `;
                item.onclick = (e) => {
                    // Don't load chat if clicking the dots button
                    if(!e.target.classList.contains('item-options-btn')) loadChat(s.id);
                }
                list.appendChild(item);
            });
        } catch (e) { console.error("Session load error", e); }
    }

    // Sidebar Context Menu (The three dots)
    function openSidebarMenu(e, sessionId) {
        e.stopPropagation();
        closeAllDropdowns();
        e.target.classList.add('active');

        const menu = document.getElementById('sidebar-context-menu');
        const rect = e.target.getBoundingClientRect();
        
        // Position menu next to the dots
        menu.style.position = 'fixed';
        menu.style.top = `${rect.bottom + 5}px`;
        menu.style.left = `${rect.left}px`;
        menu.classList.add('show');

        // Setup delete action for this specific session ID
        document.getElementById('sidebar-delete-btn').onclick = () => deleteSessionById(sessionId);
    }

    async function createNewSession(initialMessage = null) {
        // If we are already on the welcome screen and didn't pass an initial message, just focus input
        if(!currentSessionId && !initialMessage) {
             document.getElementById('user-input').focus();
             return;
        }

        const res = await fetch(`${API_URL}/sessions`, { method: 'POST' });
        const data = await res.json();
        currentSessionId = data.id;
        document.getElementById('chat-container').innerHTML = '';
        showWelcomeScreen(false);
        await loadSessions();
        document.getElementById('current-chat-name').innerText = data.title;

        if(initialMessage) {
            document.getElementById('user-input').value = initialMessage;
            sendMessage();
        }
    }

    async function loadChat(id) {
        currentSessionId = id;
        showWelcomeScreen(false);
        updateActiveSessionInSidebar();
        
        const res = await fetch(`${API_URL}/history/${id}`);
        const data = await res.json();
        
        document.getElementById('current-chat-name').innerText = data.title;
        const container = document.getElementById('chat-container');
        container.innerHTML = '';
        
        data.messages.forEach(m => appendMessage(m.sender, m.content));
        scrollToBottom();
    }

    function updateActiveSessionInSidebar() {
         document.querySelectorAll('.chat-item').forEach(item => {
            item.classList.remove('active');
             // Rough way to match ID in UI, ideally store ID on element data attribute
            if(currentSessionId && item.innerHTML.includes(`openSidebarMenu(event, ${currentSessionId})`)) {
                 item.classList.add('active');
            }
         });
    }

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const fileInput = document.getElementById('image-upload');
        const message = input.value.trim();
        const file = fileInput.files[0];

        if (!message && !file) return;

        // If no session exists, create one first, then send
        if (!currentSessionId) {
             await createNewSession();
        }

        // UI Updates
        input.value = '';
        input.style.height = 'auto'; // Reset height
        clearFile();
        checkInputState();
        
        appendMessage('user', message || (file ? 'Uploaded an image.' : ''));
        const loadingId = appendLoadingMessage();
        scrollToBottom();

        // Prepare Payload
        const formData = new FormData();
        formData.append('session_id', currentSessionId);
        if(message) formData.append('message', message);
        if (file) formData.append('image', file);

        try {
            const res = await fetch(`${API_URL}/chat`, { method: 'POST', body: formData });
            if(res.status === 429) throw new Error("Rate limit exceeded. Please check billing.");
            if(!res.ok) throw new Error("Server connection failed.");
            
            const data = await res.json();
            removeLoadingMessage(loadingId);
            appendMessage('bot', data.reply);
            loadSessions(); // Refresh titles in sidebar
        } catch (e) {
            removeLoadingMessage(loadingId);
            appendMessage('bot', `**Error:** ${e.message}. Try again later.`);
        }
        scrollToBottom();
    }

    function appendMessage(sender, text) {
        const container = document.getElementById('chat-container');
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        
        let headerHtml = '';
        if(sender === 'bot') {
             headerHtml = `
                <div class="message-header">
                    <span class="material-symbols-outlined icon-sm" style="color:var(--accent-color)">smart_toy</span>
                    <span class="bot-name">OSINT-MIND</span>
                </div>`;
        }

        // Parse Markdown for bot
        const content = sender === 'bot' ? marked.parse(text) : text.replace(/\n/g, '<br>');
        
        div.innerHTML = `
            ${headerHtml}
            <div class="message-content">${content}</div>
        `;
        container.appendChild(div);
        
        // Highlight code blocks
        div.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
        });
    }

    function appendLoadingMessage() {
        const id = 'loading-' + Date.now();
        const container = document.getElementById('chat-container');
        const div = document.createElement('div');
        div.id = id;
        div.className = 'message bot';
        div.innerHTML = `
             <div class="message-header">
                <span class="material-symbols-outlined icon-sm" style="color:var(--accent-color)">smart_toy</span>
                <span class="bot-name">OSINT-MIND</span>
            </div>
            <div class="message-content" style="display:flex; gap:5px; align-items:center;">
                 <span class="material-symbols-outlined icon-sm" style="animation:spin 2s linear infinite">progress_activity</span>
                 Analyzing target data...
            </div>
        `;
        container.appendChild(div);
        return id;
    }
    // Simple spin animation for loading icon
    const style = document.createElement('style');
    style.innerHTML = `@keyframes spin { 100% { transform: rotate(360deg); } }`;
    document.head.appendChild(style);

    function removeLoadingMessage(id) {
        const el = document.getElementById(id);
        if(el) el.remove();
    }

    function scrollToBottom() {
        const area = document.getElementById('chat-scroll-area');
        area.scrollTop = area.scrollHeight;
    }

    // --- QUICK ACTIONS (BUBBLES) ---
    function startQuickAction(prompt) {
        // If user clicks a bubble, create a new session immediately with that prompt
        createNewSession(prompt);
    }

    // --- SESSION RENAMING / DELETING ---

    async function deleteCurrentSession() {
        if(!currentSessionId || !confirm("Are you sure you want to delete this investigation history?")) return;
        await deleteSessionById(currentSessionId);
    }

    async function deleteSessionById(id) {
        try {
             await fetch(`${API_URL}/sessions/${id}`, { method: 'DELETE' });
             // If we deleted the active session, show welcome screen
             if(id === currentSessionId) {
                 showWelcomeScreen(true);
             }
             await loadSessions();
        } catch(e) { alert("Failed to delete session"); }
    }

    async function renameCurrentSession() {
        if(!currentSessionId) return;
        const newTitle = prompt("Enter new title for this investigation:");
        if(!newTitle || newTitle.trim() === "") return;
        
        try {
            const res = await fetch(`${API_URL}/sessions/${currentSessionId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: newTitle })
            });
            if(res.ok) {
                document.getElementById('current-chat-name').innerText = newTitle;
                loadSessions();
            }
        } catch(e) { alert("Failed to rename session"); }
    }

    // Placeholder for activity
    function showActivity() {
        alert("User activity tracking coming in next update.");
    }

    // Configure Marked.js
    marked.setOptions({ breaks: true, gfm: true });
</script>

</body>
</html>
