<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSINT // ANALYZER</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark-reasonable.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <style>
        /* --- THEME VARIABLES --- */
        :root[data-theme="dark"] {
            --bg-app: #000000;
            --bg-sidebar: #0a0a0a;
            --bg-chat: #000000;
            --bg-input: #111111;
            --bg-hover: #1a1a1a;
            --bg-dropdown: #1a1a1a;
            --border-color: #222;
            --accent-color: #00ff9d;
            --text-primary: #e0e0e0;
            --text-secondary: #888;
            --user-bubble-bg: #262626;
            --user-bubble-text: #fff;
            --bot-bubble-border: #00ff9d;
        }

        :root[data-theme="light"] {
            --bg-app: #ffffff;
            --bg-sidebar: #f5f5f7;
            --bg-chat: #ffffff;
            --bg-input: #f0f0f0;
            --bg-hover: #e5e5ea;
            --bg-dropdown: #ffffff;
            --border-color: #d1d1d6;
            --accent-color: #007aff;
            --text-primary: #000000;
            --text-secondary: #666;
            --user-bubble-bg: #007aff;
            --user-bubble-text: #fff;
            --bot-bubble-border: #007aff;
        }

        /* --- GLOBAL --- */
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-app); color: var(--text-primary); height: 100vh; overflow: hidden; }
        .material-symbols-outlined { font-size: 20px; }
        .icon-sm { font-size: 18px; }

        .app-container { display: flex; width: 100%; height: 100%; }

        /* --- SIDEBAR --- */
        #sidebar { width: 260px; background: var(--bg-sidebar); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; flex-shrink: 0; transition: 0.3s; }
        #sidebar.collapsed { width: 60px; }
        #sidebar.collapsed .hide-on-collapse { display: none; }
        
        .sidebar-header { padding: 20px; display: flex; align-items: center; justify-content: space-between; height: 60px; box-sizing: border-box;}
        .brand-text { font-weight: 800; font-family: monospace; letter-spacing: 1px; color: var(--accent-color); }
        .sidebar-btn-icon { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 5px; border-radius: 50%; }
        .sidebar-btn-icon:hover { background: var(--bg-hover); color: var(--text-primary); }

        .new-chat-btn-container { padding: 0 15px 10px; }
        .new-chat-btn { width: 100%; padding: 10px; background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-weight: 500; transition: 0.2s; }
        .new-chat-btn:hover { border-color: var(--accent-color); background: var(--bg-hover); }

        #history-list { flex: 1; overflow-y: auto; padding: 10px 0; }
        .chat-item { padding: 10px 20px; display: flex; align-items: center; gap: 10px; cursor: pointer; color: var(--text-primary); font-size: 0.9rem; text-decoration: none; position: relative; }
        .chat-item:hover, .chat-item.active { background: var(--bg-hover); }
        .item-options-btn { opacity: 0; margin-left: auto; color: var(--text-secondary); transition: 0.2s; }
        .chat-item:hover .item-options-btn { opacity: 1; }

        .sidebar-footer { padding: 15px; border-top: 1px solid var(--border-color); position: relative; }
        .settings-trigger { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; border-radius: 8px; color: var(--text-primary); transition: 0.2s; }
        .settings-trigger:hover { background: var(--bg-hover); }

        #settings-menu { position: absolute; bottom: 70px; left: 10px; width: 240px; background: var(--bg-dropdown); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); padding: 5px; display: none; z-index: 1000; }
        .settings-item { padding: 12px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-radius: 6px; font-size: 0.9rem; color: var(--text-primary); }
        .settings-item:hover { background: var(--bg-hover); }
        .settings-item.danger { color: #ff453a; }

        /* --- MAIN CONTENT --- */
        #main-content { flex: 1; display: flex; flex-direction: column; background: var(--bg-chat); position: relative; }
        .top-nav { height: 60px; display: flex; align-items: center; justify-content: flex-end; padding: 0 20px; position: absolute; top:0; right: 0; width: 100%; box-sizing: border-box; z-index: 10; }

        .user-chip { display: flex; align-items: center; gap: 10px; padding: 5px 10px; border-radius: 20px; cursor: pointer; transition: 0.2s; background: rgba(0,0,0,0.2); }
        .user-chip:hover { background: var(--bg-hover); }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border-color); }
        .user-name-display { font-size: 0.9rem; font-weight: 600; padding-right: 5px; }

        #chat-scroll-area { flex: 1; overflow-y: auto; padding-top: 70px; padding-bottom: 20px; }
        .message-container { max-width: 800px; margin: 0 auto; padding: 0 20px; display: flex; flex-direction: column; }

        /* --- MESSAGE BUBBLES --- */
        .message { margin-bottom: 25px; display: flex; flex-direction: column; max-width: 85%; position: relative; group; }
        .message.user { align-self: flex-end; align-items: flex-end; }
        .message.bot { align-self: flex-start; align-items: flex-start; width: 100%; max-width: 90%; }
        
        .message-content { padding: 12px 16px; font-size: 1rem; line-height: 1.5; position: relative; word-wrap: break-word; }
        
        .message.user .message-content { background: var(--user-bubble-bg); color: var(--user-bubble-text); border-radius: 18px 18px 4px 18px; }
        .message.bot .message-content { background: transparent; border: 1px solid var(--bot-bubble-border); color: var(--text-primary); border-radius: 12px; width: 100%; }

        /* SENT IMAGES STYLE */
        .chat-image { max-width: 100%; border-radius: 12px; margin-bottom: 8px; display: block; border: 1px solid rgba(255,255,255,0.1); }
        
        /* ACTION BUTTONS (Copy/Edit) */
        .action-row {
            display: flex; gap: 10px; margin-top: 5px; opacity: 0; transition: 0.2s;
        }
        .message:hover .action-row { opacity: 1; }
        
        .action-btn {
            cursor: pointer; color: var(--text-secondary); display: flex; align-items: center; gap: 4px; font-size: 0.75rem;
        }
        .action-btn:hover { color: var(--text-primary); }
        .action-btn span { font-size: 16px; }

        pre { background: #1e1e1e !important; padding: 15px; border-radius: 8px; overflow-x: auto; border: 1px solid #333; margin-top: 10px;}
        code { font-family: 'Consolas', monospace; }

        /* Input Area */
        .input-footer { padding: 20px; display: flex; justify-content: center; }
        .input-box-wrapper { width: 100%; max-width: 800px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 24px; padding: 10px 20px; display: flex; flex-direction: column; gap: 8px; transition: border-color 0.2s; }
        .input-box-wrapper:focus-within { border-color: var(--accent-color); }
        .input-row { display: flex; align-items: flex-end; gap: 10px; width: 100%; }
        
        textarea { flex: 1; background: transparent; border: none; color: var(--text-primary); resize: none; max-height: 150px; min-height: 24px; font-size: 1rem; outline: none; padding: 4px 0; }
        .send-btn { background: var(--accent-color); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .send-btn:disabled { background: var(--border-color); cursor: default; }

        #image-preview-container { display: none; width: 60px; height: 60px; position: relative; border-radius: 10px; overflow: hidden; border: 1px solid var(--border-color); animation: fadeIn 0.3s; }
        .preview-thumb { width: 100%; height: 100%; object-fit: cover; }
        .remove-file-btn { position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .remove-file-btn:hover { background: rgba(0,0,0,0.8); }

        /* Overlays */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-btn { padding: 12px 24px; background: #fff; color: #000; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; display: flex; gap: 10px; align-items: center;}
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-card { background: var(--bg-dropdown); border: 1px solid var(--border-color); width: 350px; padding: 30px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); text-align: center; position: relative; }
        .modal-close { position: absolute; top: 15px; right: 15px; cursor: pointer; color: var(--text-secondary); }
        .profile-large-img { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 15px; border: 2px solid var(--accent-color); }
        
        #welcome-screen { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: none; width: 100%; }
        .welcome-title { font-size: 2.5rem; font-weight: 800; margin-bottom: 10px; }
        .bubble-grid { display: flex; gap: 10px; justify-content: center; margin-top: 30px; }
        .suggestion-chip { background: var(--bg-input); border: 1px solid var(--border-color); padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; }
        .suggestion-chip:hover { border-color: var(--accent-color); }
    </style>
</head>
<body>

    <div id="login-overlay">
        <h1 style="color: var(--accent-color); letter-spacing: 2px;">OSINT ANALYZER</h1>
        <p style="color: #666; margin-bottom: 30px;">Secure Workspace</p>
        <button class="login-btn" onclick="loginWithGoogle()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Sign in with Google
        </button>
    </div>

    <div class="modal-overlay" id="profile-modal">
        <div class="modal-card">
            <span class="material-symbols-outlined modal-close" onclick="closeProfile()">close</span>
            <img src="" id="modal-img" class="profile-large-img">
            <h2 id="modal-name"></h2>
            <p id="modal-email" style="color: var(--text-secondary); margin-bottom: 20px;"></p>
            <div style="background: var(--bg-input); padding: 10px; border-radius: 8px; font-size: 0.85rem; color: var(--text-secondary);">
                Member Since: <span id="modal-joined"></span>
            </div>
        </div>
    </div>

    <div class="app-container" id="app-content" style="filter: blur(5px); pointer-events: none;">
        <div id="sidebar">
            <div class="sidebar-header">
                <span class="brand-text hide-on-collapse">OSINT</span>
                <button class="sidebar-btn-icon" onclick="toggleSidebar()">
                    <span class="material-symbols-outlined">menu</span>
                </button>
            </div>
            <div class="new-chat-btn-container hide-on-collapse">
                <button class="new-chat-btn" onclick="createNewSession()">
                    <span class="material-symbols-outlined">add</span> New Chat
                </button>
            </div>
            <div id="history-list"></div>
            <div class="sidebar-footer">
                <div class="settings-trigger" onclick="toggleSettingsMenu()">
                    <span class="material-symbols-outlined">settings</span> <span class="hide-on-collapse">Settings</span>
                </div>
                <div id="settings-menu">
                    <div class="settings-item" onclick="toggleTheme()"><span class="material-symbols-outlined">contrast</span> Theme</div>
                    <a href="https://docs.google.com/forms/d/e/1FAIpQLScxln0wQ_S7q69WEbE1WtjB4-cYaNphpRki0sLVqyBip2W5qA/viewform" target="_blank" class="settings-item" style="text-decoration:none;"><span class="material-symbols-outlined">chat_bubble</span> Feedback</a>
                    <div class="settings-item" onclick="alert('Activity feature coming soon.')"><span class="material-symbols-outlined">history</span> Activity</div>
                    <div style="height:1px; background:var(--border-color); margin: 5px 0;"></div>
                    <div class="settings-item danger" onclick="logout()"><span class="material-symbols-outlined">logout</span> Sign Out</div>
                </div>
            </div>
        </div>

        <div id="main-content">
            <div class="top-nav">
                <div class="user-chip" onclick="openProfile()">
                    <span class="user-name-display" id="header-name">Agent</span>
                    <img src="" id="header-img" class="user-avatar">
                </div>
            </div>

            <div id="chat-scroll-area">
                <div class="message-container" id="chat-container"></div>
                <div id="welcome-screen">
                    <div class="welcome-title">Welcome, <span id="welcome-user-name">Hacker</span>.</div>
                    <p style="color:var(--text-secondary)">Secure channel established.</p>
                    <div class="bubble-grid">
                        <div class="suggestion-chip" onclick="startQuickAction('Analyze this image for geolocation clues')">üì∏ Image Intel</div>
                        <div class="suggestion-chip" onclick="startQuickAction('Find social media accounts for username:')">üîé Deep Search</div>
                        <div class="suggestion-chip" onclick="startQuickAction('List common OSINT tools for email investigation')">üõ†Ô∏è Tools List</div>
                    </div>
                </div>
            </div>

            <div class="input-footer">
                <div class="input-box-wrapper">
                    <div id="image-preview-container">
                        <img id="image-preview-element" class="preview-thumb">
                        <div class="remove-file-btn" onclick="clearFile()"><span class="material-symbols-outlined" style="font-size: 14px;">close</span></div>
                    </div>
                    <div class="input-row">
                        <input type="file" id="image-upload" style="display:none" onchange="handleFileSelect()">
                        <label for="image-upload" style="cursor:pointer; color:var(--text-secondary); padding-bottom:5px;">
                            <span class="material-symbols-outlined">attach_file</span>
                        </label>
                        <textarea id="user-input" rows="1" placeholder="Enter target data..." oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'" onkeydown="handleEnter(event)"></textarea>
                        <button class="send-btn" onclick="sendMessage()"><span class="material-symbols-outlined icon-sm">arrow_upward</span></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="context-menu" style="position:fixed; background:var(--bg-dropdown); border:1px solid var(--border-color); display:none; border-radius:8px; padding:5px; z-index:9999;">
        <div class="settings-item danger" id="ctx-delete-btn" style="padding:10px;"><span class="material-symbols-outlined icon-sm">delete</span> Delete</div>
    </div>

<script>
    // --- FIREBASE CONFIG (ADD YOURS HERE) ---
    const firebaseConfig = {
      apiKey: "AIzaSyD8tEMKd82XQ4PikhUCjZTA1iQ-XbAhLYw",
      authDomain: "osint-ai-eaf84.firebaseapp.com",
      projectId: "osint-ai-eaf84",
      storageBucket: "osint-ai-eaf84.firebasestorage.app",
      messagingSenderId: "610494544590",
      appId: "1:610494544590:web:0d5e1482f430caa329ae9f"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    let currentUserToken = null;
    let currentUserName = "Agent";

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUserToken = await user.getIdToken();
            currentUserName = user.displayName || "Agent";
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app-content').style.filter = 'none';
            document.getElementById('app-content').style.pointerEvents = 'all';
            document.getElementById('header-name').innerText = currentUserName;
            const photo = user.photoURL || 'https://www.gravatar.com/avatar/?d=mp';
            document.getElementById('header-img').src = photo;
            document.getElementById('welcome-user-name').innerText = currentUserName.split(' ')[0];
            document.getElementById('modal-name').innerText = currentUserName;
            document.getElementById('modal-email').innerText = user.email;
            document.getElementById('modal-img').src = photo;
            document.getElementById('modal-joined').innerText = new Date(user.metadata.creationTime).toLocaleDateString();
            loadSessions();
        } else {
            document.getElementById('login-overlay').style.display = 'flex';
        }
    });

    function loginWithGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
    function logout() { auth.signOut(); location.reload(); }

    const originalFetch = window.fetch;
    window.fetch = async (url, options = {}) => {
        if (!options.headers) options.headers = {};
        if (currentUserToken) options.headers['Authorization'] = `Bearer ${currentUserToken}`;
        return originalFetch(url, options);
    };
</script>

<script>
    let currentSessionId = null;
    const API_URL = '';
    
    // FILE HANDLING
    function handleFileSelect() {
        const file = document.getElementById('image-upload').files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('image-preview-element').src = e.target.result;
                document.getElementById('image-preview-container').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }
    function clearFile() {
        document.getElementById('image-upload').value = '';
        document.getElementById('image-preview-container').style.display = 'none';
        document.getElementById('image-preview-element').src = '';
    }

    // UTILS
    function copyText(text) {
        navigator.clipboard.writeText(text).then(() => alert("Copied to clipboard!"));
    }
    function editText(text) {
        document.getElementById('user-input').value = text;
        document.getElementById('user-input').focus();
    }

    // CHAT RENDERING
    function appendMessage(sender, text, imageData = null) {
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        
        let contentHtml = '';
        if (imageData) {
            contentHtml += `<img src="data:image/jpeg;base64,${imageData}" class="chat-image">`;
        }
        
        contentHtml += sender === 'bot' ? marked.parse(text) : text.replace(/\n/g, '<br>');
        
        // Add Action Buttons (Copy/Edit)
        let actionsHtml = `<div class="action-row">
            <div class="action-btn" onclick="copyText(\`${text.replace(/`/g, "\\`")}\`)"><span class="material-symbols-outlined" style="font-size:14px">content_copy</span> Copy</div>`;
        
        if (sender === 'user') {
            actionsHtml += `<div class="action-btn" onclick="editText(\`${text.replace(/`/g, "\\`")}\`)"><span class="material-symbols-outlined" style="font-size:14px">edit</span> Edit</div>`;
        }
        actionsHtml += `</div>`;

        div.innerHTML = `<div class="message-content">${contentHtml}</div>${actionsHtml}`;
        
        document.getElementById('chat-container').appendChild(div);
        div.querySelectorAll('pre code').forEach(hljs.highlightElement);
        document.getElementById('chat-scroll-area').scrollTop = document.getElementById('chat-scroll-area').scrollHeight;
    }

    async function loadChat(id) {
        currentSessionId = id;
        toggleWelcome(false);
        const res = await fetch(`${API_URL}/history/${id}`);
        const data = await res.json();
        const container = document.getElementById('chat-container');
        container.innerHTML = '';
        // Updated to pass image data
        data.messages.forEach(m => appendMessage(m.sender, m.content, m.image));
        loadSessions();
    }

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const fileInput = document.getElementById('image-upload');
        const text = input.value.trim();
        const file = fileInput.files[0];

        if(!text && !file) return;
        if(!currentSessionId) { await createNewSession(null, true); }

        // Optimistic Render
        let previewBase64 = null;
        if(file) {
            // Need to read file to render it instantly before server responds
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                 previewBase64 = reader.result.split(',')[1]; // Strip header
                 appendMessage('user', text, previewBase64); // Render instantly
            }
        } else {
             appendMessage('user', text);
        }

        input.value = '';
        clearFile();
        const loadingId = appendLoading();

        const formData = new FormData();
        formData.append('session_id', currentSessionId);
        formData.append('user_name', currentUserName);
        if(text) formData.append('message', text);
        if(file) formData.append('image', file);

        try {
            const res = await fetch(`${API_URL}/chat`, { method: 'POST', body: formData });
            const data = await res.json();
            document.getElementById(loadingId).remove();
            appendMessage('bot', data.reply);
            loadSessions();
        } catch(e) {
            document.getElementById(loadingId).remove();
            appendMessage('bot', `Error: ${e.message}`);
        }
    }

    // OTHER BOILERPLATE (Session loading, UI toggles, same as before)
    async function loadSessions() {
        const res = await fetch(`${API_URL}/sessions`);
        const sessions = await res.json();
        const list = document.getElementById('history-list');
        list.innerHTML = '<div style="padding:10px 20px; font-size:0.8rem; color:var(--text-secondary); font-weight:bold;" class="hide-on-collapse">CHATS</div>';
        sessions.forEach(s => {
            const item = document.createElement('div');
            item.className = `chat-item ${s.id === currentSessionId ? 'active' : ''}`;
            item.innerHTML = `<span class="material-symbols-outlined icon-sm">chat_bubble_outline</span><span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1;" class="hide-on-collapse">${s.title}</span><span class="material-symbols-outlined icon-sm item-options-btn hide-on-collapse" onclick="openContext(event, ${s.id})">more_horiz</span>`;
            item.onclick = (e) => { if(!e.target.classList.contains('item-options-btn')) loadChat(s.id); };
            list.appendChild(item);
        });
    }

    async function createNewSession(initialMsg = null, force = false) {
        if(!currentSessionId && !initialMsg && !force) { document.getElementById('user-input').focus(); return; }
        const res = await fetch(`${API_URL}/sessions`, { method: 'POST' });
        const data = await res.json();
        currentSessionId = data.id;
        document.getElementById('chat-container').innerHTML = '';
        toggleWelcome(false);
        loadSessions();
        if(initialMsg) { document.getElementById('user-input').value = initialMsg; sendMessage(); }
    }

    function appendLoading() {
        const id = 'loading-' + Date.now();
        const div = document.createElement('div');
        div.id = id;
        div.className = 'message bot';
        div.innerHTML = `<div class="message-content">Analyzing...</div>`;
        document.getElementById('chat-container').appendChild(div);
        return id;
    }

    function toggleWelcome(show) { document.getElementById('welcome-screen').style.display = show ? 'block' : 'none'; document.getElementById('chat-container').style.display = show ? 'none' : 'flex'; if(show) currentSessionId = null; }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }
    function toggleSettingsMenu() { const menu = document.getElementById('settings-menu'); menu.style.display = menu.style.display === 'block' ? 'none' : 'block'; }
    function toggleTheme() { const html = document.documentElement; const current = html.getAttribute('data-theme'); const next = current === 'dark' ? 'light' : 'dark'; html.setAttribute('data-theme', next); localStorage.setItem('theme', next); }
    function openProfile() { document.getElementById('profile-modal').style.display = 'flex'; }
    function closeProfile() { document.getElementById('profile-modal').style.display = 'none'; }
    function startQuickAction(text) { createNewSession(text); }
    function openContext(e, id) { e.stopPropagation(); const menu = document.getElementById('context-menu'); menu.style.display = 'block'; menu.style.left = e.clientX + 'px'; menu.style.top = e.clientY + 'px'; document.getElementById('ctx-delete-btn').onclick = async () => { if(confirm('Delete chat?')) { await fetch(`${API_URL}/sessions/${id}`, { method: 'DELETE' }); if(currentSessionId === id) toggleWelcome(true); loadSessions(); } }; }
    function handleEnter(e) { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
    
    document.addEventListener('click', (e) => {
        if(!e.target.closest('.settings-trigger')) document.getElementById('settings-menu').style.display = 'none';
        if(!e.target.closest('.item-options-btn')) document.getElementById('context-menu').style.display = 'none';
        if(e.target.className === 'modal-overlay') closeProfile();
    });

    if(localStorage.getItem('theme') === 'light') toggleTheme();
    window.onload = async () => { toggleWelcome(true); };
</script>

</body>
</html>
