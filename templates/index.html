<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <script>
        Object.defineProperty(navigator, 'userAgent', {
            get: function () { return 'Mozilla/5.0 (Linux; Android 10; Mobile) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Mobile Safari/537.36'; }
        });
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LEGACY OSINT AI</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark-reasonable.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="manifest" href="/static/manifest.json">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="OSINT">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/4712/4712035.png">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <style>
        /* --- THEME VARIABLES --- */
        :root[data-theme="dark"] {
            --bg-app: #000000;
            --bg-sidebar: #0a0a0a;
            --bg-chat: #000000;
            --bg-input: #111111;
            --bg-hover: #1a1a1a;
            --bg-dropdown: #1a1a1a;
            --border-color: #222;
            --accent-color: #00ff9d;
            --text-primary: #e0e0e0;
            --text-secondary: #888;
            --user-bubble-bg: #262626;
            --user-bubble-text: #fff;
            --bot-bubble-border: #00ff9d;
            --think-bg: #111;
            --think-border: #333;
            --neon-green: #00ff41;
        }

        :root[data-theme="light"] {
            --bg-app: #ffffff;
            --bg-sidebar: #f5f5f7;
            --bg-chat: #ffffff;
            --bg-input: #f0f0f0;
            --bg-hover: #e5e5ea;
            --bg-dropdown: #ffffff;
            --border-color: #d1d1d6;
            --accent-color: #007aff;
            --text-primary: #000000;
            --text-secondary: #666;
            --user-bubble-bg: #007aff;
            --user-bubble-text: #fff;
            --bot-bubble-border: #007aff;
            --think-bg: #f9f9f9;
            --think-border: #ddd;
        }

        /* --- GLOBAL --- */
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-app); color: var(--text-primary); height: 100dvh; overflow: hidden; overscroll-behavior-y: none; }
        .material-symbols-outlined { font-size: 20px; }
        .icon-sm { font-size: 18px; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .app-container { display: flex; width: 100%; height: 100%; position: relative; }

        /* --- SIDEBAR --- */
        #sidebar { width: 260px; background: var(--bg-sidebar); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; flex-shrink: 0; transition: transform 0.3s ease, width 0.3s ease; z-index: 100; }
        #sidebar.collapsed { width: 0px; border: none; overflow: hidden;}
        .sidebar-header { padding: 20px; display: flex; align-items: center; justify-content: space-between; height: 60px; box-sizing: border-box;}
        .brand-text { font-weight: 800; font-family: monospace; letter-spacing: 1px; color: var(--accent-color); }
        .sidebar-btn-icon { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 5px; border-radius: 50%; }
        #mobile-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 90; display: none; }
        .new-chat-btn-container { padding: 0 15px 10px; }
        .new-chat-btn { width: 100%; padding: 10px; background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-weight: 500; transition: 0.2s; }
        #history-list { flex: 1; overflow-y: auto; padding: 10px 0; }
        .chat-item { padding: 10px 20px; display: flex; align-items: center; gap: 10px; cursor: pointer; color: var(--text-primary); font-size: 0.9rem; text-decoration: none; position: relative; white-space: nowrap; overflow: hidden; }
        .chat-item:hover, .chat-item.active { background: var(--bg-hover); }
        .item-options-btn { opacity: 0; margin-left: auto; color: var(--text-secondary); transition: 0.2s; }
        .chat-item:hover .item-options-btn { opacity: 1; }
        .sidebar-footer { padding: 15px; border-top: 1px solid var(--border-color); position: relative; }
        .settings-trigger { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; border-radius: 8px; color: var(--text-primary); transition: 0.2s; }
        #settings-menu { position: absolute; bottom: 70px; left: 10px; width: 220px; background: var(--bg-dropdown); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); padding: 5px; display: none; z-index: 1000; }
        .settings-item { padding: 12px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-radius: 6px; font-size: 0.9rem; color: var(--text-primary); }
        .settings-item.danger { color: #ff453a; }

        /* --- MAIN CONTENT --- */
        #main-content { flex: 1; display: flex; flex-direction: column; background: var(--bg-chat); position: relative; width: 100%; height: 100%; }
        .mobile-header { display: none; height: 50px; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid var(--border-color); background: var(--bg-app); position: absolute; top:0; left:0; width: 100%; box-sizing: border-box; z-index: 50; }
        .top-nav { height: 60px; display: flex; align-items: center; justify-content: flex-end; padding: 0 20px; position: absolute; top:0; right: 0; width: 100%; box-sizing: border-box; z-index: 10; pointer-events: none; }
        .user-chip { pointer-events: auto; display: flex; align-items: center; gap: 10px; padding: 5px 10px; border-radius: 20px; cursor: pointer; transition: 0.2s; background: rgba(0,0,0,0.2); backdrop-filter: blur(5px); }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border-color); }
        .user-name-display { font-size: 0.9rem; font-weight: 600; padding-right: 5px; }

        #chat-scroll-area { flex: 1; overflow-y: auto; padding-top: 70px; padding-bottom: 10px; overscroll-behavior-y: contain; -webkit-overflow-scrolling: touch;}
        .message-container { max-width: 800px; margin: 0 auto; padding: 0 20px; display: flex; flex-direction: column; }

        /* --- BUBBLES --- */
        .message { margin-bottom: 25px; display: flex; flex-direction: column; max-width: 85%; position: relative; }
        .message.user { align-self: flex-end; align-items: flex-end; max-width: 90%; }
        .message.bot { align-self: flex-start; align-items: flex-start; width: 100%; max-width: 95%; }
        
        .message-content { padding: 12px 16px; font-size: 1rem; line-height: 1.5; position: relative; word-wrap: break-word; overflow-wrap: break-word; }
        .message.user .message-content { background: var(--user-bubble-bg); color: var(--user-bubble-text); border-radius: 18px 18px 4px 18px; }
        .message.bot .message-content { background: transparent; border: 1px solid var(--bot-bubble-border); color: var(--text-primary); border-radius: 12px; width: 100%; }

        /* --- SHOW THINKING WIDGET --- */
        .thinking-container { width: 100%; max-width: 100%; margin-bottom: 10px; }
        details.thinking-details { background: var(--think-bg); border: 1px solid var(--think-border); border-radius: 12px; overflow: hidden; transition: all 0.2s ease; }
        details.thinking-details summary { list-style: none; padding: 8px 12px; cursor: pointer; font-size: 0.85rem; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; font-weight: 500; user-select: none; }
        details.thinking-details summary::-webkit-details-marker { display: none; }
        details.thinking-details summary:hover { color: var(--text-primary); background: var(--bg-hover); }
        .thinking-icon { color: var(--accent-color); font-size: 18px; }
        .thinking-content { padding: 12px 15px; border-top: 1px solid var(--think-border); font-size: 0.9rem; color: var(--text-secondary); font-family: monospace; white-space: pre-wrap; line-height: 1.5; background: rgba(0,0,0,0.2); }

        .chat-image { max-width: 100%; border-radius: 12px; margin-bottom: 8px; display: block; border: 1px solid rgba(255,255,255,0.1); }
        .action-row { display: flex; gap: 10px; margin-top: 5px; opacity: 0; transition: 0.2s; }
        .message:hover .action-row { opacity: 1; }
        .action-btn { cursor: pointer; color: var(--text-secondary); display: flex; align-items: center; gap: 4px; font-size: 0.75rem; }

        pre { background: #1e1e1e !important; padding: 15px; border-radius: 8px; overflow-x: auto; border: 1px solid #333; margin-top: 10px; max-width: 100%; }
        code { font-family: 'Consolas', monospace; }

        /* --- INPUT --- */
        .input-footer { padding: 10px 15px; background: var(--bg-app); display: flex; justify-content: center; position: relative; z-index: 20; padding-bottom: calc(15px + env(safe-area-inset-bottom)); border-top: 1px solid var(--border-color); }
        .input-box-wrapper { width: 100%; max-width: 800px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 24px; padding: 8px 15px; display: flex; flex-direction: column; gap: 8px; transition: border-color 0.2s; }
        .input-row { display: flex; align-items: center; gap: 10px; width: 100%; }
        textarea { flex: 1; background: transparent; border: none; color: var(--text-primary); resize: none; max-height: 120px; min-height: 24px; font-size: 1rem; outline: none; padding: 4px 0; line-height: 1.4; }
        .send-btn { background: var(--accent-color); color: #000; border: none; width: 34px; height: 34px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s, box-shadow 0.2s; flex-shrink: 0; }
        .send-btn:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 0 8px var(--accent-color); }
        .send-btn:disabled { background: var(--border-color); cursor: default; opacity: 0.5; transform: none; box-shadow: none;}
        #image-preview-container { display: none; width: 60px; height: 60px; position: relative; border-radius: 10px; overflow: hidden; border: 1px solid var(--border-color); animation: fadeIn 0.3s; margin-bottom: 5px;}
        .preview-thumb { width: 100%; height: 100%; object-fit: cover; }
        .remove-file-btn { position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* --- WELCOME --- */
        #welcome-screen { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: none; width: 90%; max-width: 600px; }
        .welcome-title { font-size: 2.5rem; font-weight: 800; margin-bottom: 10px; opacity: 0; animation: slideUp 0.6s forwards; }
        .welcome-subtext { color: var(--text-secondary); margin-bottom: 30px; opacity: 0; animation: slideUp 0.6s 0.2s forwards; }
        .bubble-grid { display: flex; gap: 10px; justify-content: center; margin-top: 30px; opacity: 0; animation: fadeIn 0.8s 0.4s forwards; }
        .suggestion-chip { background: var(--bg-input); border: 1px solid var(--border-color); padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .suggestion-chip:hover { border-color: var(--accent-color); background: var(--bg-hover); }

        @media (max-width: 768px) {
            #sidebar { position: absolute; height: 100%; width: 80%; max-width: 300px; transform: translateX(-100%); }
            #sidebar.active { transform: translateX(0); box-shadow: 10px 0 50px rgba(0,0,0,0.5); }
            #sidebar.collapsed { width: 80%; max-width: 300px; transform: translateX(-100%); } 
            .mobile-header { display: flex; } 
            .top-nav { top: 50px; justify-content: flex-end; padding: 10px; pointer-events: none;} 
            .user-chip { padding: 4px 8px; pointer-events: auto; }
            .user-name-display { display: none; }
            #chat-scroll-area { padding-top: 60px; }
            .message-container { padding: 0 15px; }
            .input-footer { padding: 10px; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
            textarea { font-size: 16px; } 
            .action-row { opacity: 1; }
            #welcome-screen { top: 45%; }
            .welcome-title { font-size: 1.8rem; }
            .bubble-grid { flex-direction: column; align-items: center; gap: 12px;}
            .suggestion-chip { width: 100%; justify-content: center; box-sizing: border-box; }
        }

        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-btn { padding: 12px 24px; background: #fff; color: #000; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; display: flex; gap: 10px; align-items: center;}
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-card { background: var(--bg-dropdown); border: 1px solid var(--border-color); width: 90%; max-width: 350px; padding: 30px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); text-align: center; position: relative; }
        .modal-close { position: absolute; top: 15px; right: 15px; cursor: pointer; color: var(--text-secondary); }
        .profile-large-img { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 15px; border: 2px solid var(--accent-color); }
        .pro-watermark-btn { margin: 10px 15px; padding: 10px; background: rgba(0, 255, 65, 0.05); border: 1px solid var(--neon-green); color: var(--neon-green); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 700; font-family: monospace; letter-spacing: 1px; transition: all 0.3s ease; text-transform: uppercase; box-shadow: 0 0 5px rgba(0, 255, 65, 0.1); }
        .pro-watermark-btn:hover { background: var(--neon-green); color: black; box-shadow: 0 0 20px rgba(0, 255, 65, 0.4); }
        #pro-modal-overlay { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); backdrop-filter: blur(8px); justify-content: center; align-items: center; animation: fadeIn 0.3s; }
        .pro-card-box {
            background: #000;
            border: 2px solid var(--neon-green);
            width: 90%;
            max-width: 400px;
            padding: 2px; /* Creates the double border effect */
            position: relative;
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.15);
        }
        .pro-card-inner {
            border: 1px solid var(--neon-green);
            padding: 30px;
            text-align: center;
            position: relative;
        }
        .corner-accent {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--neon-green);
            z-index: 2;
        }
        .tl { top: 0; left: 0; }
        .tr { top: 0; right: 0; }
        .bl { bottom: 0; left: 0; }
        .br { bottom: 0; right: 0; }
        
        .pro-title {
            color: var(--neon-green);
            font-family: monospace;
            font-size: 2rem;
            margin: 0;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
            letter-spacing: -1px;
        }
        
        .pro-price {
            color: white;
            font-size: 3.5rem;
            font-weight: 800;
            margin: 10px 0;
        }
        
        .pro-price span {
            font-size: 1rem;
            color: #888;
            font-weight: normal;
        }
        
        .pro-features {
            text-align: left;
            margin: 20px 0;
            color: #ccc;
            font-family: monospace;
            list-style: none;
            padding: 0;
        }
        .pro-features li {
            padding: 8px 0;
            border-bottom: 1px solid #222;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .check-icon { color: var(--neon-green); font-weight: bold; }
        .go-pro-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background: var(--neon-green);
            color: black;
            font-weight: 900;
            font-size: 1.1rem;
            border: none;
            text-transform: uppercase;
            cursor: pointer;
            transition: transform 0.2s;
            text-decoration: none;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        .go-pro-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 0 20px var(--neon-green);
        }
        
        .close-pro {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #555;
            cursor: pointer;
            font-size: 24px;
            transition: color 0.2s;
        }
        .close-pro:hover { color: var(--neon-green); }
    </style>
</head>
<body>

    <div id="login-overlay">
        <h1 style="color: var(--accent-color); letter-spacing: 2px;">OSINT ANALYZER</h1>
        <p style="color: #666; margin-bottom: 30px;">Secure Workspace</p>
        <button class="login-btn" onclick="loginWithGoogle()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Sign in with Google
        </button>
    </div>

    <div class="modal-overlay" id="profile-modal">
        <div class="modal-card">
            <span class="material-symbols-outlined modal-close" onclick="closeProfile()">close</span>
            <img src="" id="modal-img" class="profile-large-img">
            <h2 id="modal-name"></h2>
            <p id="modal-email" style="color: var(--text-secondary); margin-bottom: 20px;"></p>
            <div style="background: var(--bg-input); padding: 10px; border-radius: 8px; font-size: 0.85rem; color: var(--text-secondary);">
                Member Since: <span id="modal-joined"></span>
            </div>
        </div>
    </div>

    <div id="mobile-overlay" onclick="toggleSidebar()"></div>
    <div class="app-container" id="app-content" style="filter: blur(5px); pointer-events: none;">
        <div id="sidebar">
            <div class="sidebar-header">
                <span class="brand-text">OSINT</span>
                <button class="sidebar-btn-icon" onclick="toggleSidebar()" style="display: none; @media(min-width:769px){display:block;}"><span class="material-symbols-outlined">menu_open</span></button>
                <button class="sidebar-btn-icon" onclick="toggleSidebar()" style="display: block; @media(min-width:769px){display:none;}"><span class="material-symbols-outlined">close</span></button>
            </div>
            <div class="new-chat-btn-container">
                <button class="new-chat-btn" onclick="createNewSession(); if(window.innerWidth<=768) toggleSidebar();"><span class="material-symbols-outlined">add</span> New Chat</button>
            </div>
            <div id="history-list"></div>
            <div class="sidebar-footer">
                <div class="pro-watermark-btn" onclick="openProModal()" style="margin: 10px 0; padding: 10px; border: 1px solid #00ff41; color: #ffffff; border-radius: 8px; cursor: pointer; text-align: center; font-weight: bold; font-family: monospace;">‚ú® LEGACY PRO</div>
                <div class="settings-trigger" onclick="toggleSettingsMenu()"><span class="material-symbols-outlined">settings</span> <span>Settings</span></div>
                <div id="settings-menu">
                    <div class="settings-item" onclick="toggleTheme()"><span class="material-symbols-outlined">contrast</span> Theme</div>
                    <div class="settings-item" onclick="openSubscriptionModal()"><span class="material-symbols-outlined">credit_card</span> Manage Subscription</div>
                    <a href="https://docs.google.com/forms/d/e/1FAIpQLScxln0wQ_S7q69WEbE1WtjB4-cYaNphpRki0sLVqyBip2W5qA/viewform" target="_blank" class="settings-item" style="text-decoration:none;"><span class="material-symbols-outlined">chat_bubble</span> Feedback</a>
                    <div class="settings-item" onclick="alert('Activity feature coming soon.')"><span class="material-symbols-outlined">history</span> Activity</div>
                    <div style="height:1px; background:var(--border-color); margin: 5px 0;"></div>
                    <div class="settings-item danger" onclick="logout()"><span class="material-symbols-outlined">logout</span> Sign Out</div>
                </div>
            </div>
        </div>

        <div id="main-content">
            <div class="mobile-header">
                <button class="sidebar-btn-icon" onclick="toggleSidebar()"><span class="material-symbols-outlined">menu</span></button>
                <span class="brand-text" style="font-size: 1rem;">OSINT</span>
                <div style="width: 24px;"></div>
            </div>
            <div class="top-nav">
                <div class="user-chip" onclick="openProfile()">
                    <span class="user-name-display" id="header-name">Agent</span>
                    <img src="" id="header-img" class="user-avatar">
                </div>
            </div>

            <div id="chat-scroll-area">
                <div class="message-container" id="chat-container"></div>
                <div id="welcome-screen">
                    <div class="welcome-title">Welcome, <span id="welcome-user-name">Hacker</span>.</div>
                    <p class="welcome-subtext">Secure channel established.</p>
                    <div class="bubble-grid">
                        <div class="suggestion-chip" onclick="startQuickAction('Analyze this image for geolocation clues')"><span>üì∏</span> Image Intel</div>
                        <div class="suggestion-chip" onclick="startQuickAction('Find social media accounts for username:')"><span>üîé</span> Deep Search</div>
                        <div class="suggestion-chip" onclick="startQuickAction('List common OSINT tools for email investigation')"><span>üõ†Ô∏è</span> Tools List</div>
                    </div>
                </div>
            </div>

            <div class="input-footer">
                <div class="input-box-wrapper">
                    <div id="image-preview-container">
                        <img id="image-preview-element" class="preview-thumb">
                        <div class="remove-file-btn" onclick="clearFile()"><span class="material-symbols-outlined" style="font-size: 14px;">close</span></div>
                    </div>
                    <div class="input-row">
                        <input type="file" id="image-upload" style="display:none" onchange="handleFileSelect()">
                        <label for="image-upload" style="cursor:pointer; color:var(--text-secondary); padding: 5px;">
                            <span class="material-symbols-outlined">attach_file</span>
                        </label>
                        <textarea id="user-input" rows="1" placeholder="Enter target data..." oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'" onkeydown="handleEnter(event)"></textarea>
                        <button class="send-btn" onclick="sendMessage()"><span class="material-symbols-outlined icon-sm">send</span></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    

    <div id="context-menu" style="position:fixed; background:var(--bg-dropdown); border:1px solid var(--border-color); display:none; border-radius:8px; padding:5px; z-index:9999;">
        <div class="settings-item danger" id="ctx-delete-btn" style="padding:10px;"><span class="material-symbols-outlined icon-sm">delete</span> Delete</div>
    </div>

    <div id="sub-modal-overlay" onclick="closeSubModal(event)" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); justify-content: center; align-items: center;">
        <div style="background: #111; border: 1px solid #333; width: 90%; max-width: 400px; border-radius: 12px; padding: 25px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
            <span onclick="document.getElementById('sub-modal-overlay').style.display='none'" style="position: absolute; top: 15px; right: 20px; color: #666; cursor: pointer; font-size: 24px;">&times;</span>
            
            <h2 style="margin-top: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px;">
                <span class="material-symbols-outlined">credit_card</span> Subscription
            </h2>
            
            <div style="background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 20px; margin: 20px 0; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="color: #888; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;">Current Plan</div>
                    <div id="sub-plan-name" style="font-size: 1.5rem; font-weight: bold; margin-top: 5px; color: white;">Free Tier</div>
                </div>
                <div id="sub-status-badge" style="background: #333; color: #ccc; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">Active</div>
            </div>
    
            <div style="color: #888; font-size: 0.9rem; margin-bottom: 20px; line-height: 1.5;" id="sub-details-text">
                You are currently on the limited Free tier. Upgrade to unlock full capabilities.
            </div>
    
            <div id="sub-action-container">
                </div>
        </div>
    </div>

<script>
    // --- FIREBASE CONFIG (Add your keys back here) ---
    const firebaseConfig = {
      apiKey: "AIzaSyD8tEMKd82XQ4PikhUCjZTA1iQ-XbAhLYw",
      authDomain: "osint-ai-eaf84.firebaseapp.com",
      projectId: "osint-ai-eaf84",
      storageBucket: "osint-ai-eaf84.firebasestorage.app",
      messagingSenderId: "610494544590",
      appId: "1:610494544590:web:0d5e1482f430caa329ae9f"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    let currentUserToken = null;
    let currentUserName = "Agent";

    // --- LOGIN FUNCTION (FIXED) ---
    function loginWithGoogle() {
        console.log("Attempting Google Login...");
        const provider = new firebase.auth.GoogleAuthProvider();

        // Use Popup first (Best for Web/PWA)
        auth.signInWithPopup(provider)
            .then((result) => {
                console.log("Login success:", result.user.email);
                // The onAuthStateChanged listener handles the UI updates
            })
            .catch((error) => {
                console.error("Popup Failed:", error);

                // ONLY fallback to redirect if popup is strictly blocked
                if (error.code === 'auth/popup-blocked' || error.code === 'auth/popup-closed-by-user') {
                    auth.signInWithRedirect(provider);
                } else {
                    alert("Login Error: " + error.message);
                }
            });
    }

    // --- HANDLE REDIRECT RESULT ---
    // This runs automatically on page load to catch users returning from a Redirect login
    auth.getRedirectResult()
        .then((result) => {
            if (result.user) console.log("Recovered from redirect login");
        })
        .catch((error) => {
            console.error("Redirect Verify Error:", error);
        });

    // --- MONITOR AUTH STATE ---
    // This triggers whenever the user logs in (via Popup OR Redirect)
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            console.log("User detected:", user.email);
            currentUserToken = await user.getIdToken();
            currentUserName = user.displayName || "Agent";
            

            // Update UI
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app-content').style.filter = 'none';
            document.getElementById('app-content').style.pointerEvents = 'all';

            // Set Headers
            document.getElementById('header-name').innerText = currentUserName;
            const photo = user.photoURL || 'https://www.gravatar.com/avatar/?d=mp';
            document.getElementById('header-img').src = photo;
            document.getElementById('welcome-user-name').innerText = currentUserName.split(' ')[0];

            // Set Profile Modal Data
            document.getElementById('modal-name').innerText = currentUserName;
            document.getElementById('modal-email').innerText = user.email;
            document.getElementById('modal-img').src = photo;
            document.getElementById('modal-joined').innerText = new Date(user.metadata.creationTime).toLocaleDateString();
    
            // CHECK PRO STATUS
            fetch('/api/get_pro_status', {
                headers: { 'Authorization': 'Bearer ' + currentUserToken }
            })
            .then(res => res.json())
            .then(data => {
                if (data.is_pro) {
                    // Add badge to header name
                    const badge = ' <span style="background:#00ff41; color:black; font-size:0.7rem; padding:2px 6px; border-radius:4px; font-weight:bold; vertical-align:middle;">PRO</span>';
                    document.getElementById('header-name').innerHTML += badge;
                    
                    // Add badge to profile modal name
                    document.getElementById('modal-name').innerHTML += badge;
                    
                    // Hide the "Upgrade" button in sidebar since they already have it
                    const upgradeBtn = document.querySelector('.pro-watermark-btn');
                    if(upgradeBtn) upgradeBtn.style.display = 'none';
                }
            });
            
            // Load Chats
            loadSessions();
        } else {
            console.log("No user signed in");
            document.getElementById('login-overlay').style.display = 'flex';
        }
    });

    function logout() { 
        auth.signOut().then(() => location.reload()); 
    }

    // Intercept Fetch to add Auth Token
    const originalFetch = window.fetch;
    window.fetch = async (url, options = {}) => {
        if (!options.headers) options.headers = {};
        if (currentUserToken) options.headers['Authorization'] = `Bearer ${currentUserToken}`;
        return originalFetch(url, options);
    };
</script>

<script>
    let currentSessionId = null;
    const API_URL = '';
    
    function handleFileSelect() {
        const file = document.getElementById('image-upload').files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('image-preview-element').src = e.target.result;
                document.getElementById('image-preview-container').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }
    function clearFile() {
        document.getElementById('image-upload').value = '';
        document.getElementById('image-preview-container').style.display = 'none';
        document.getElementById('image-preview-element').src = '';
    }

    function copyText(text) { navigator.clipboard.writeText(text).then(() => alert("Copied to clipboard!")); }
    function editText(text) { document.getElementById('user-input').value = text; document.getElementById('user-input').focus(); }

    function appendMessage(sender, text, imageData = null) {
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        
        let mainText = text;
        let thoughtHtml = '';
        
        // --- PARSE "THINKING" TAGS ---
        const thinkMatch = text.match(/<think>([\s\S]*?)<\/think>/);
        if (thinkMatch) {
            const thinkingContent = thinkMatch[1].trim();
            mainText = text.replace(thinkMatch[0], '').trim();
            
            // Create the Gemini-Style Collapsible Widget
            thoughtHtml = `
            <div class="thinking-container">
                <details class="thinking-details">
                    <summary>
                        <span class="material-symbols-outlined thinking-icon" style="color:var(--accent-color)">auto_awesome</span>
                        Show thinking
                    </summary>
                    <div class="thinking-content">${thinkingContent}</div>
                </details>
            </div>
            `;
        }

        let contentHtml = '';
        if (imageData) { contentHtml += `<img src="data:image/jpeg;base64,${imageData}" class="chat-image">`; }
        
        // Add Thinking Widget ABOVE the main text
        if (thoughtHtml) { contentHtml += thoughtHtml; }
        
        contentHtml += sender === 'bot' ? marked.parse(mainText) : mainText.replace(/\n/g, '<br>');
        
        let actionsHtml = `<div class="action-row"><div class="action-btn" onclick="copyText(\`${mainText.replace(/`/g, "\\`")}\`)"><span class="material-symbols-outlined" style="font-size:14px">content_copy</span> Copy</div>`;
        if (sender === 'user') { actionsHtml += `<div class="action-btn" onclick="editText(\`${mainText.replace(/`/g, "\\`")}\`)"><span class="material-symbols-outlined" style="font-size:14px">edit</span> Edit</div>`; }
        actionsHtml += `</div>`;
        
        div.innerHTML = `<div class="message-content">${contentHtml}</div>${actionsHtml}`;
        document.getElementById('chat-container').appendChild(div);
        div.querySelectorAll('pre code').forEach(hljs.highlightElement);
        document.getElementById('chat-scroll-area').scrollTop = document.getElementById('chat-scroll-area').scrollHeight;
    }

    async function loadChat(id) {
        currentSessionId = id;
        toggleWelcome(false);
        const res = await fetch(`${API_URL}/history/${id}`);
        const data = await res.json();
        const container = document.getElementById('chat-container');
        container.innerHTML = '';
        data.messages.forEach(m => appendMessage(m.sender, m.content, m.image));
        loadSessions();
        if(window.innerWidth <= 768) {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('mobile-overlay').style.display = 'none';
        }
    }

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const fileInput = document.getElementById('image-upload');
        const text = input.value.trim();
        const file = fileInput.files[0];
        if(!text && !file) return;
        if(!currentSessionId) { await createNewSession(null, true); }
        let previewBase64 = null;
        if(file) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                 previewBase64 = reader.result.split(',')[1];
                 appendMessage('user', text, previewBase64);
            }
        } else { appendMessage('user', text); }
        input.value = '';
        clearFile();
        const loadingId = appendLoading();
        const formData = new FormData();
        formData.append('session_id', currentSessionId);
        formData.append('user_name', currentUserName);
        if(text) formData.append('message', text);
        if(file) formData.append('image', file);
        try {
            const res = await fetch(`${API_URL}/chat`, { method: 'POST', body: formData });
            const data = await res.json();
            document.getElementById(loadingId).remove();
            appendMessage('bot', data.reply);
            loadSessions();
        } catch(e) {
            document.getElementById(loadingId).remove();
            appendMessage('bot', `Error: ${e.message}`);
        }
    }

    async function loadSessions() {
        const res = await fetch(`${API_URL}/sessions`);
        const sessions = await res.json();
        const list = document.getElementById('history-list');
        list.innerHTML = '<div style="padding:10px 20px; font-size:0.8rem; color:var(--text-secondary); font-weight:bold;" class="hide-on-collapse">CHATS</div>';
        sessions.forEach(s => {
            const item = document.createElement('div');
            item.className = `chat-item ${s.id === currentSessionId ? 'active' : ''}`;
            item.innerHTML = `<span class="material-symbols-outlined icon-sm">chat_bubble_outline</span><span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1;" class="hide-on-collapse">${s.title}</span><span class="material-symbols-outlined icon-sm item-options-btn hide-on-collapse" onclick="openContext(event, ${s.id})">more_horiz</span>`;
            item.onclick = (e) => { if(!e.target.classList.contains('item-options-btn')) loadChat(s.id); };
            list.appendChild(item);
        });
    }

    async function createNewSession(initialMsg = null, force = false) {
        if(!currentSessionId && !initialMsg && !force) { document.getElementById('user-input').focus(); return; }
        const res = await fetch(`${API_URL}/sessions`, { method: 'POST' });
        const data = await res.json();
        currentSessionId = data.id;
        document.getElementById('chat-container').innerHTML = '';
        toggleWelcome(false);
        loadSessions();
        if(initialMsg) { document.getElementById('user-input').value = initialMsg; sendMessage(); }
    }

    function appendLoading() {
        const id = 'loading-' + Date.now();
        const div = document.createElement('div');
        div.id = id;
        div.className = 'message bot';
        div.innerHTML = `<div class="message-content">Thinking...</div>`;
        document.getElementById('chat-container').appendChild(div);
        return id;
    }

    function toggleWelcome(show) { document.getElementById('welcome-screen').style.display = show ? 'block' : 'none'; document.getElementById('chat-container').style.display = show ? 'none' : 'flex'; if(show) currentSessionId = null; }
    function toggleSidebar() { const sb = document.getElementById('sidebar'); const overlay = document.getElementById('mobile-overlay'); if (window.innerWidth <= 768) { sb.classList.toggle('active'); overlay.style.display = sb.classList.contains('active') ? 'block' : 'none'; } else { sb.classList.toggle('collapsed'); } }
    function toggleSettingsMenu() { const menu = document.getElementById('settings-menu'); menu.style.display = menu.style.display === 'block' ? 'none' : 'block'; }
    function toggleTheme() { const html = document.documentElement; const current = html.getAttribute('data-theme'); const next = current === 'dark' ? 'light' : 'dark'; html.setAttribute('data-theme', next); localStorage.setItem('theme', next); }
    function openProfile() { document.getElementById('profile-modal').style.display = 'flex'; }
    function closeProfile() { document.getElementById('profile-modal').style.display = 'none'; }
    function startQuickAction(text) { createNewSession(text); }
    function openContext(e, id) { e.stopPropagation(); const menu = document.getElementById('context-menu'); menu.style.display = 'block'; menu.style.left = e.clientX + 'px'; menu.style.top = e.clientY + 'px'; document.getElementById('ctx-delete-btn').onclick = async () => { if(confirm('Delete chat?')) { await fetch(`${API_URL}/sessions/${id}`, { method: 'DELETE' }); if(currentSessionId === id) toggleWelcome(true); loadSessions(); } }; }
    function handleEnter(e) { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
    
    document.addEventListener('click', (e) => {
        if(!e.target.closest('.settings-trigger')) document.getElementById('settings-menu').style.display = 'none';
        if(!e.target.closest('.item-options-btn')) document.getElementById('context-menu').style.display = 'none';
        if(e.target.className === 'modal-overlay') closeProfile();
    });

    if(localStorage.getItem('theme') === 'light') toggleTheme();
    window.onload = async () => { toggleWelcome(true); };
</script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(registration => {
          console.log('Service Worker registered with scope:', registration.scope);
        })
        .catch(error => {
          console.log('Service Worker registration failed:', error);
        });
    });
  }
</script>

<div id="pro-modal-overlay" onclick="closeProModal(event)">
    <div class="pro-card-box">
        <div class="corner-accent tl"></div>
        <div class="corner-accent tr"></div>
        <div class="corner-accent bl"></div>
        <div class="corner-accent br"></div>
        
        <div class="pro-card-inner">
            <span class="close-pro" onclick="document.getElementById('pro-modal-overlay').style.display='none'">&times;</span>
            
            <h2 class="pro-title">LEGACY // PRO</h2>
            <p style="color: #666; font-family: monospace; font-size: 0.8rem; margin-top: 5px;">SYSTEM UPGRADE AVAILABLE</p>
            <div style="display: flex; justify-content: space-around; margin-bottom: 20px;">
        <div style="text-align: center;">
        <div class="pro-price" style="font-size: 2.5rem; margin: 0;">$5<span>/mo</span></div>
        <div style="color: #888; font-size: 0.8rem; font-family: monospace;">Monthly</div>
    </div>
    <div style="text-align: center;">
        <div class="pro-price" style="font-size: 2.5rem; margin: 0;">$50<span>/yr</span></div>
        <div style="color: #888; font-size: 0.8rem; font-family: monospace;">Yearly (Save $10)</div>
    </div>
</div>

<ul class="pro-features">
    <li><span class="check-icon">>></span> Unlimited Intelligence Uploads</li>
    <li><span class="check-icon">>></span> Priority Neural Processing</li>
    <li><span class="check-icon">>></span> Deep Web Scraper Access</li>
    <li><span class="check-icon">>></span> Support Development</li>
</ul>

<div style="display: flex; gap: 10px; margin-top: 20px;">
    <a href="/create-checkout-session?plan=monthly" class="go-pro-btn" style="flex: 1; text-align: center; padding: 15px 0;">
        MONTHLY
    </a>
    <a href="/create-checkout-session?plan=yearly" class="go-pro-btn" style="flex: 1; text-align: center; padding: 15px 0;">
        YEARLY
    </a>
</div>

<script>
    function openProModal() {
        document.getElementById('pro-modal-overlay').style.display = 'flex';
        // Close sidebar on mobile if open
        if(window.innerWidth <= 768) {
            const sb = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            if(sb) sb.classList.remove('active');
            if(overlay) overlay.style.display = 'none';
        }
    }

    function closeProModal(e) {
        // Only close if clicking the dark background (overlay), not the card itself
        if (e.target.id === 'pro-modal-overlay') {
            document.getElementById('pro-modal-overlay').style.display = 'none';
        }
    }
    
    // --- SUBSCRIPTION MANAGEMENT LOGIC ---
    async function openSubscriptionModal() {
        // 1. Close Settings Menu
        document.getElementById('settings-menu').style.display = 'none';
        
        // 2. Open the Modal
        const modal = document.getElementById('sub-modal-overlay');
        modal.style.display = 'flex';
        
        // 3. Check Status
        const planName = document.getElementById('sub-plan-name');
        const statusBadge = document.getElementById('sub-status-badge');
        const detailsText = document.getElementById('sub-details-text');
        const actionContainer = document.getElementById('sub-action-container');
        
        // Loading state
        actionContainer.innerHTML = '<div style="color:#666; text-align:center;">Checking status...</div>';
    
        try {
            const res = await fetch('/api/get_pro_status', {
                headers: { 'Authorization': 'Bearer ' + currentUserToken }
            });
            const data = await res.json();
            
            if (data.is_pro) {
                // --- USER IS PRO ---
                planName.innerHTML = '<span style="color:#00ff41; text-shadow: 0 0 10px rgba(0,255,65,0.3);">LEGACY PRO</span>';
                statusBadge.style.background = 'rgba(0, 255, 65, 0.2)';
                statusBadge.style.color = '#00ff41';
                statusBadge.innerText = 'ACTIVE';
                detailsText.innerText = 'You have full access to all neural networks, unlimited uploads, and priority processing.';
                
                // Show CANCEL Button
                actionContainer.innerHTML = `
                    <button onclick="cancelSubscription()" style="width: 100%; padding: 12px; background: transparent; border: 1px solid #ff453a; color: #ff453a; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s;">
                        CANCEL SUBSCRIPTION
                    </button>
                `;
            } else {
                // --- USER IS FREE ---
                planName.innerHTML = 'Free Agent';
                statusBadge.style.background = '#333';
                statusBadge.style.color = '#ccc';
                statusBadge.innerText = 'LIMITED';
                detailsText.innerText = 'You are currently on the limited Free tier (5 uploads/day). Upgrade to unlock full capabilities.';
                
                // Show UPGRADE Button
                actionContainer.innerHTML = `
                    <button onclick="openProModal(); document.getElementById('sub-modal-overlay').style.display='none';" style="width: 100%; padding: 12px; background: #00ff41; border: none; color: black; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        UPGRADE NOW
                    </button>
                `;
            }
        } catch (e) {
            console.error(e);
            actionContainer.innerHTML = '<div style="color:red;">Error loading status</div>';
        }
    }
    
    async function cancelSubscription() {
        if(!confirm("Are you sure you want to cancel your Pro benefits? You will lose access immediately.")) return;
        
        const btn = document.querySelector('#sub-action-container button');
        btn.innerText = "CANCELLING...";
        btn.disabled = true;
    
        try {
            const res = await fetch('/api/cancel_subscription', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + currentUserToken }
            });
            const data = await res.json();
            
            if(data.status === 'cancelled') {
                alert("Subscription cancelled. You have been reverted to the Free tier.");
                location.reload(); // Reload to update UI badges
            } else {
                alert("Error cancelling subscription.");
                btn.innerText = "CANCEL SUBSCRIPTION";
                btn.disabled = false;
            }
        } catch (e) {
            alert("Connection error.");
        }
    }
    
    function closeSubModal(e) {
        if (e.target.id === 'sub-modal-overlay') {
            document.getElementById('sub-modal-overlay').style.display = 'none';
        }
    }
</script>
</body>
</html>
